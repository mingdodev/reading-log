# 뉴스 피드 시스템 설계

모바일 앱 / 웹, 주요 기능, 피드 구성 순서, 사용자 당 최대 친구(특별한 관계) 수, 트래픽 규모, 피드를 구성하는 데이터의 특징(미디어 파일 포함 여부) 등을 파악하고, 시스템을 설계한다.

## 뉴스 피드 API

- 포스팅(사용자의 활동에 의해 생성되는 것), 피드(포스팅을 시간 역순으로 보여주는 서비스)

    - 포스팅 저장 서비스: 새 포스팅을 데이터베이스와 포스팅 캐시에 저장
    
    - 포스팅 전송 서비스: 새 포스팅을 친구의 뉴스 피드에 푸시, 피드 캐시에 저장

    - 알림 서비스: 친구들에게 새 포스팅이 올라왔음을 알림

### 피드 캐시와 포스팅 캐시의 차이?

- 피드 캐시: 각 사용자의 피드를 구성하는 포스팅 ID의 목록을 저장, 피드 구성의 효율을 더함

- 포스팅 캐시: 개별 포스팅의 원본 내용을 저장, 피드 캐시 접근 후 포스팅에 접근할 때 디스크 접근을 최소화함

### 피드는 '잦은 변경'이 있는 개념이라고 생각하는데, 어떻게 캐시로 성능을 높이는 거지?

**내 질문**: 근데 사용자별 피드 캐시는 사실상 접속할 때마다 또는 매순간 바뀔텐데, 즉 자주 변경되는 데이터라고 생각이 되는데 왜 캐시로 관리하는 거야?

**gemini**: 자주 바뀌는 데이터임에도 캐시를 사용하는 이유는, '얼마나 자주 바뀌는가'보다 **'피드를 새로 만드는 비용이 얼마나 비싼가'**가 훨씬 더 중요하기 때문입니다. 즉, 캐시를 사용함으로써 얻는 성능상의 이점이 데이터 변경을 관리하는 비용을 압도적으로 뛰어넘습니다.

만약 피드 캐시가 없다면, 사용자가 피드를 새로고침 할 때마다 다음과 같은 복잡하고 비용이 큰 작업을 데이터베이스(DB)에서 수행해야 합니다.

- 친구 목록 조회: 사용자가 팔로우하는 모든 친구(수백~수천 명)의 목록을 DB에서 가져옵니다.

- 친구별 최신 포스팅 조회: 각 친구마다 그들의 최신 포스팅을 DB에서 가져옵니다. 친구가 500명이면 500번의 추가 조회가 필요할 수 있습니다.

- 데이터 병합 및 정렬: 모든 친구의 포스팅을 하나의 거대한 목록으로 합친 후, 시간 역순으로 정렬합니다. 수만, 수십만 개의 데이터를 정렬하는 것은 DB에 엄청난 부하를 줍니다.

- 후처리: 광고를 삽입하거나, 내가 차단한 사용자의 글을 제외하는 등의 추가 로직을 적용합니다.

- 페이징: 최종적으로 상위 20개만 잘라서 사용자에게 보여줍니다.

이 모든 과정은 여러 테이블을 조인하고, 대규모 정렬을 수행하는 등 DB를 끔찍하게 괴롭히는 작업입니다. 사용자가 많아질수록 시스템은 순식간에 마비될 것입니다.

피드 캐시는 이 비싼 계산을 사용자가 요청하는 시점이 아닌, 글이 작성되는 시점에 미리 해두는 전략을 사용합니다.

읽기 경로 (Read Path): 사용자가 피드를 요청하면, 시스템은 단 한 번의 조회로 Redis 같은 피드 캐시에서 user_id를 Key로 하여 이미 완성된 포스팅 ID 목록을 즉시 꺼내줍니다. DB는 전혀 건드리지 않으므로 응답 속도는 수십~수백 배 빨라집니다.

쓰기 경로 (Write Path): A라는 사용자가 글을 쓰면, 포스팅 전송 서비스가 백그라운드에서 A를 팔로우하는 모든 친구들의 피드 캐시에 A의 새 포스팅 ID를 추가해 줍니다. 이 작업은 시간이 약간 걸릴 수 있지만, 사용자 입장에서는 글을 쓰는 행위 자체는 즉시 완료되므로 전혀 문제 되지 않습니다.

| 구분 | 피드를 매번 DB에서 생성 | 피드 캐시 사용 |
|----|----|----|
| 응답 속도 | 느림 (수백ms ~ 수초) | 매우 빠름 (수ms) |
| DB 부하 | 매우 높음 (복잡한 쿼리) | 거의 없음 (캐시에서 처리) |
| 사용자 경험 | 새로고침 할 때마다 렉이 걸림 | 부드럽고 즉각적인 피드 로딩 |

결론적으로, 피드 캐시는 '읽기 성능'을 극대화하기 위해 '쓰기' 시점에 미리 계산된 데이터를 준비해두는 공간입니다. 데이터가 아무리 자주 바뀌더라도, 매번 비싼 계산을 반복하는 것보다 미리 계산된 결과를 빠르게 꺼내주는 것이 전체 시스템의 안정성과 사용자 경험에 훨씬 더 유리하기 때문에 캐시로 관리하는 것입니다.

> 잦은 변경이 있지만 최초 구성이 매우 복잡하고 디스크를 힘들게 하는 작업이라면, 캐시에 변경사항을 반영해서 제공하는 게 좋을 것이다. 오히려 너무 자주 바뀐다면 그만큼 영구적으로 보존할 필요가 없다는 뜻이니, 어찌보면 메모리에서 관리하는 게 자연스럽네. 잠시 보존하는 데이터(이메일 인증 번호 등)는 어떻게 다뤄야 할까? 이런 식으로 목적을 먼저 생각하고 알맞은 설계를 스스로 떠올려보자!!