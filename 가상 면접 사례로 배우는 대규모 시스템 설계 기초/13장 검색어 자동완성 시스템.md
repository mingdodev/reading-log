# 검색어 자동완성 시스템

## 개략적 설계안

- 실시간 검색 데이터 수집 서비스

- 질의 서비스 (n개의 연관 검색어 가져오기)

```sql

    # 관계형 데이터베이스 사용

    select * from frequency_table
    where query like `prefix%`
    order by frequency desc
    limit 5

```

데이터 양이 적을 때는 이정도로 가능하겠지만, 데이터가 아주 많아진다면 DB가 병목이 될 수 있다.

## 상세 설계

### 트라이 자료구조

- 트리 형태의 자료구조로, 문자열을 간략하게 저장할 수 있다.

- 문자열을 꺼내는 연산에 굿

- 최악의 시간복잡도를 피하기 위해, 접두어의 최대 길이(검색어의 최대 길이)를 제한하거나 노드마다 인기 검색어를 캐시해둘 수 있다.

### 데이터 수집 서비스

데이터 분석 서비스 로그 -> 로그 취합 서버 -> 취합된 데이터 -> 작업 서버가 저장 처리 -> 트라이 캐시 주기적 업데이트 -> 트라이 데이터베이스

우리 서비스에서의 **검색 실시간성**을 따진 뒤 트라이를 얼마에 한 번 업데이트 할지 결정한다.

### 질의 서비스

- AJAX 요청

- 브라우저 캐싱

- 데이터 샘플링 기법: N개 요청 가운데 1개만 로깅한다.

### 트라이 연산

- 매주 한 번 갱신하거나 각 노드 개별 갱신(트라이가 작을 때)

- 위험한 질의어의 경우 '필터 계층'을 두고 API 서버가 반환할 때 걸러준다. 데이터베이스 상에서 필터링하는 것은 다음번 업데이트 사이클에 비동기적으로 진행한다.

### 규모 확장이 가능한 저장소

-  트라이는 키-값 저장소 또는 도큐먼트 저장소에 보관할 수 있다.

- 확장시에는 질의 첫 글자(혹은 그 이후)를 기준으로 규칙을 만들어 샤딩할 수 있다. 그러나 이 방식은 균등 분배가 어렵다. 따라서 '검색어 대응 샤드 관리자'로 어떤 질의가 어느 샤드에 있는지 확인하는 데이터베이스를 따로 둘 수 있다.